<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test BMCP Encoding in Browser</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .result {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .hex { 
            word-break: break-all; 
            background: #f8f8f8; 
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üî® BMCP Dashboard Encoding Test</h1>
    <p>Testing BitcoinCommandEncoder in browser environment</p>
    
    <div id="output"></div>
    
    <script type="module">
        import { Buffer } from 'https://esm.sh/buffer@6.0.3';
        
        // Make Buffer global
        window.Buffer = Buffer;
        
        const output = document.getElementById('output');
        
        function log(html) {
            output.innerHTML += html;
        }
        
        async function testEncoding() {
            try {
                log('<div class="result"><h2>Test 1: Buffer Polyfill</h2>');
                
                // Test Buffer
                const testBuf = Buffer.from('BMCP', 'ascii');
                log(`<p class="success">‚úÖ Buffer.from works</p>`);
                log(`<p>Magic bytes: 0x${testBuf.toString('hex')}</p>`);
                
                // Test BigInt buffer writing
                const buf = Buffer.alloc(8);
                buf.writeBigUInt64BE(BigInt('0x8f90b8876dee6538'));
                log(`<p class="success">‚úÖ writeBigUInt64BE works</p>`);
                log(`<p>Chain selector: 0x${buf.toString('hex')}</p>`);
                
                log('</div>');
                
                // Try loading the SDK (this would normally be bundled)
                log('<div class="result"><h2>Test 2: Manual BMCP Encoding</h2>');
                
                // Simulate what BitcoinCommandEncoder does
                const parts = [];
                
                // Protocol Magic
                const magic = Buffer.alloc(4);
                magic.writeUInt32BE(0x424D4350); // "BMCP"
                parts.push(magic);
                
                // Version
                parts.push(Buffer.from([0x01]));
                
                // Chain Selector (Base Sepolia)
                const chain = Buffer.alloc(8);
                chain.writeBigUInt64BE(BigInt('0x8f90b8876dee6538'));
                parts.push(chain);
                
                // Contract (20 bytes)
                const contract = Buffer.from('2bae8224110482ec6ddf12faf359a35362d43573', 'hex');
                parts.push(contract);
                
                // Mock function data (simplified)
                const data = Buffer.from('f21355f4', 'hex');
                const dataLen = Buffer.alloc(2);
                dataLen.writeUInt16BE(data.length);
                parts.push(dataLen);
                parts.push(data);
                
                // Nonce
                const nonce = Buffer.alloc(4);
                nonce.writeUInt32BE(0);
                parts.push(nonce);
                
                // Deadline
                const deadline = Buffer.alloc(4);
                deadline.writeUInt32BE(1763874250);
                parts.push(deadline);
                
                const bmcpPayload = Buffer.concat(parts);
                const bmcpHex = '0x' + bmcpPayload.toString('hex');
                
                log(`<p class="success">‚úÖ Manual BMCP encoding successful!</p>`);
                log(`<p><strong>BMCP Data (${bmcpPayload.length} bytes):</strong></p>`);
                log(`<div class="hex">${bmcpHex}</div>`);
                
                log('</div>');
                
                log('<div class="result"><h2 class="success">‚úÖ All Tests Passed!</h2>');
                log('<p>The dashboard should work correctly now.</p>');
                log('<p><strong>Next steps:</strong></p>');
                log('<ol>');
                log('<li>Start the dashboard: <code>cd packages/dashboard && npm run dev</code></li>');
                log('<li>Open http://localhost:8080</li>');
                log('<li>Click "Generate BMCP Data" button</li>');
                log('<li>You should see encoded BMCP data like above!</li>');
                log('</ol>');
                log('</div>');
                
            } catch (error) {
                log(`<div class="result"><h2 class="error">‚ùå Error</h2>`);
                log(`<p class="error">${error.message}</p>`);
                log(`<pre>${error.stack}</pre>`);
                log('</div>');
            }
        }
        
        testEncoding();
    </script>
</body>
</html>

